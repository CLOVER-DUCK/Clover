<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport"
	content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/css/reset.css">
<link rel="stylesheet" href="/css/fundingPay.css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
	crossorigin="anonymous">
<!-- 아임포트 라이브러리 -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

<!-- iamport.payment.js -->
<script src="https://cdn.iamport.kr/v1/iamport.js"></script>
<script type="text/javascript"
	src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
<script type="text/javascript">
	/* 추후 로그인된 유저 세션 정보 가져오기 */

	/* function getUserDetails() {
	 $.ajax({
	 url: '/api/getUserDetails',  // 현재 로그인된 아이디와 회원 상세 정보를 가져오는 API 엔드포인트 URL
	 method: 'GET',
	 success: function(response) {
	 // 성공적으로 데이터를 가져왔을 때의 처리
	 // 가져온 데이터를 활용하여 결제 API 호출을 처리합니다
	 console.log(response);
	 // ... 결제 API를 호출하는 함수를 호출하고, 데이터를 전달합니다 ...
	 makePayment(response);
	 },
	 error: function(xhr, status, error) {
	 // AJAX 요청이 실패했을 때의 처리
	 console.error(error);
	 // ... 에러 처리 로직을 구현하세요 ...
	 }
	 });
	 }
	 */
</script>

<script type="text/javascript">
$(document).ready(function() {
	
	 /* 구매 희망주 입력 시 총 펀딩 금액 값 변경 - 1주당금액*희망주 / 해당값 */
	$('#fundHope').on('input',function() {
		var fundHope = parseFloat($('#fundHope').val().replace(/,/g, ''));
		var fundTotal = 10000 * fundHope; //펀딩 구매 희망주
		var alloTotal = 2 * fundHope; //배당금 예상 금액
		var finalTotal = fundTotal + alloTotal; // 최종 예상 금액

		if (isNaN(fundTotal)) {
			$('#fundTotal').text('0');
			$('#alloTotal').text('0');
			$('#finalTotal').text('0');
			$('#expectPoint').text('0');
		} else {
			$('#fundTotal').text(fundTotal.toLocaleString());
			$('#alloTotal').text(alloTotal.toLocaleString());
			$('#finalTotal').text(finalTotal.toLocaleString());
			$('#expectPoint').text(fundTotal.toLocaleString());
		}

		var fT = fundTotal;
		var nowPoint = [[${nowPoint}]];
		
		console.log("fT = " +fT);
		console.log("nowPoint = " + nowPoint );
	 });	
	
	/* 수익금 지급 예상일 - 오늘 날짜 기준 3개월 후  */
	/* --> 추후 펀딩 종료 기간 설정시 해당 종료일 기준 3개월 후로 코드 변경 */
	function getCurrentDate() {
		var today = new Date();
		return today.getFullYear() + '년 '
				+ (today.getMonth() + 1) + '월 '
				+ today.getDate() + '일';
	}

	// 3개월 후의 날짜 계산
	function getFutureDate() {
		var futureDate = new Date();
		futureDate.setMonth(futureDate.getMonth() + 3);
		return futureDate.getFullYear() + '년 '
				+ (futureDate.getMonth() + 1) + '월 '
				+ futureDate.getDate() + '일';
	}

	// exchangeDate 요소에 표시
	document.getElementById('exchangeDate').textContent = getFutureDate();

});//ready End

//투자하기 버튼 클릭시
function fundingPay () {
		var fundHope = document.getElementById('fundHope').value;
		var fundTotal = $('#fundTotal').text();		
		var fT = fundTotal.replace(/,/g, "");
		var nowPoint = [[${nowPoint}]];
		
		console.log("fundingPay() fT = " +fT);
		console.log("fundingPay() nowPoint = " + nowPoint );
		console.log(fT>nowPoint);
		
		if(fT>nowPoint){ //총 펀딩 금액이 현재 잔여 포인트보다 많을 경우 --> 포인트 충전 필요
			document.getElementById('lackPoint').style.display="";
			document.getElementById('charge_money').focus();
		}else{ //총 펀딩 금액이 현재 잔여 포인트보다 같거나 적을 경우 --> 펀딩하기 버튼 활성화
			
			document.getElementById('lackPoint').style.display="none";
			
			//추후 저장된 유저 세션값으로 변경할 것 
			var amount = fT;
			var type = 1; //0 충전, 1 사용
			var wallet_id = 1;
			var funding_id = 1;
			
			console.log("amount = " + amount);
			$.ajax({					
				url : "/fundingPay",
				type : "POST",
				dataType:"json",
				data : {amount : amount, 
						type : type,
						wallet_id : wallet_id, 
						funding_id : funding_id},
				success: function(response) {
			        var amount = response.amount;
			        var data = response.data;
			        var date = response.date;
			        
			        $("date").text(date);
			        //$("#nowPoint").text(amount);
			        $("#status").text(amount);

			        console.log("Amount: " + amount);
			        console.log("Data: " + data);
			        
			        /////////////현재 데이터 저장은 성공/////////////////
			        /////////////페이지 이동만 되면 완료////////////////
			        //locaiton.href='fundingPayFin';
			    },
			    error: function(jqXHR, textStatus, errorThrown) {
			        // 에러 처리를 하는 부분입니다.
			        console.error("Request failed: " + textStatus, errorThrown);
			    }		
			});//ajax End
		}

		if (fundHope == null ||  fundHope === "") {
			alert("펀딩 구매 희망주를 입력하세요.");
			document.getElementById('fundHope').focus();
			return;
		}
		
		//버튼 비활성화
		//document.getElementById('fundingPayButton').disabled = true;	  	
}
</script>

<!-- 아임포트 결제 처리  -->
<script type="text/javascript">

	var IMP = window.IMP;
	var code = "imp78536886"; //가맹점 식별코드
	IMP.init(code);

	function requestPay() {
		
		var money = document.getElementById('charge_money').value;
		if (money == null ||  money === "") {
			alert("충전할 금액을 입력해주세요.");
			document.getElementById('charge_money').focus();
			return;
		}
		
		/*pointHistory에 필요한 정보  */
		/* type, amount, create_at, funding_id, wallet_id */
		
		/* 추후 session에 회원정보가 존재할 경우, 아래처럼 수정 예정 */
        /* var user_id = [[${session.userid}]];
        var user_email =  [[${session.email}]];
        var user_name =  [[${session.name}]]; */        
        
        var user_id = 1;	//유저 아이디(pk)
        var wallet_id = 1; 	//유저 월렛 id
        var user_email =  'example@example.com';
        var user_name =  '조아영';
        var user_phone = '010-1234-5678';
        var funding_id = '1';
        var funding_name = '파도, 인진에서 "파력 에너지"로 다시 태어나다';    
        var type = 0; //충전 0, 사용 1, 환전 2
        var currentTime = new Date();

		IMP.request_pay({
			pg : "html5_inicis", //pg사 구분코드 - 이니시스 웹표준
			pay_method : 'card', //결제수단 구분코드 - 신용카드
			merchant_uid : 'point_' + new Date().getTime(), //주문번호
			name : funding_name, //결제대상 16byte이내
			amount : money, //결제금액
			buyer_name : user_name, //주문자명
			buyer_tel : user_phone, //주문자연락처
			buyer_email : user_email, //주문자 이메일
			
			//pc_redirect_url : '/mypage/pointCharge' //결제완료 후 이동 URL
		}, function(rsp) {
			console.log(rsp);
			
			if (rsp.success) { //결제 성공시
				var msg = "[결제 완료]";
				msg += " 결제 방법 = " + rsp.pay_method;
				msg += " 결제 금액 = " + rsp.paid_amount;
				msg += " 주문자명 = " + rsp.buyer_name;
				console.log(msg);
				alert("결제가 완료되었습니다.");
				
				
				//데이터 전송
				$.ajax({					
					url : "/mypage/pointCharge",
					type : "POST",
					dataType:"json",
					data : {amount : rsp.paid_amount, 
						type : type,
						wallet_id : wallet_id},
					success: function(response) {
				        var amount = response.amount;
				        var data = response.data;
				        var date = response.date;
				        
				        $("date").text(date);
				        //$("#nowPoint").text(amount);
				        $("#status").text(amount);

				        console.log("Amount: " + amount);
				        console.log("Data: " + data);
				        
				        location.href = "/fundingPay";
				       
				    },
				    error: function(jqXHR, textStatus, errorThrown) {
				        // 에러 처리를 하는 부분입니다.
				        console.error("Request failed: " + textStatus, errorThrown);
				    }
					
				});
				//window.location.href = rsp.next_redirect_pc_url; // 웹 페이지 이동

			} else { //결제 실패시
				var msg = "[결제 실패 : " + rsp.error_code + "]";
				msg += " 에러 내용 : " + rsp.error_msg;
				console.log(msg);

				//충전 금액 입력 null 일 경우 발생 에러 메세지
				//[결제 실패 : F1001] 에러 내용 : 결제요청금액이 0원입니다. 빌링키발급을 위해 customer_uid가 지정될 때에만 0원이 허용됩니다. 요청 amount :

				alert("결제를 실패하였습니다.");
			}
		});
	}
</script>


<title>CLOVER | 펀딩</title>
<!--  펀딩 투자하기 - 펀딩하기 -->
<style>
#my_modal {
	display: none;
	width: 300px;
	padding: 20px 60px;
	background-color: #fefefe;
	border: 1px solid #888;
	border-radius: 3px;
}

#my_modal .modal_close_btn {
	position: absolute;
	top: 10px;
	right: 10px;
}
</style>
</head>
<body>
	<div>
		<div class="nav">네브바</div>
		<div class="banner">배너</div>
		<div class="container">
			<div class="section">
				<div class="info-detail-container">
					<div class="sequence-img-container">
						<img class="sequence-img" src="/img/fundingAgree2.png" alt="">
					</div>
					<div class="info-input-container">
						<div class="funding-info1">
							<div class="funding-info-title">기업정보</div>
							<div class="funding-info-container1">
								<div>
									<img class="funding-info-img" src="/img/granhand_sample_01.png"
										alt="">
								</div>
								<div>
									<div class="funding-info-name">
										<img class="funding-logo" src="/img/granhand_logo_01.png"
											alt="Card image cap">
										<h5 class="card-title">그랑핸드</h5>
									</div>
									<div>최초 플라스틱 분해 기업</div>
									<div class="card-title-keyword">
										<div class="keword rounded bg-light text-primary">#러버추천</div>
										<div class="keword rounded bg-light text-primary">#성공률50%</div>
									</div>

								</div>
							</div>
						</div>
						<div class="funding-info2">
							<div class="funding-info-title">펀딩 구매 희망주</div>
							<div class="funding-info-container2">
								<div>펀딩 최대금액 제한(해당 펀딩 최대금액의 25%)</div>
								<div>
									<input type="text" id="fundHope" class="">주
								</div>
							</div>
							<div style="text-align: right;">펀딩 구매 희망주 변경은 5/31까지 가능합니다.</div>
						</div>
						<div class="funding-info3">
							<div class="funding-info-title">최종 펀딩정보</div>
							<div class="funding-info-container3">
								<div class="funding-amount-title">
									<div>총 펀딩 금액</div>
									<div class="funding-amount">
										<div>1주당금액*구매희망주</div>
										<div id="fundTotal">0</div>
										원
									</div>

								</div>
								<div>
									<div class="funding-amount">
										<div>배당금 예상 금액</div>
										<div id="alloTotal">0</div>
										원
									</div>
									<div class="funding-amount">
										<div>최종 예상 수익금액</div>
										<div id="finalTotal">0</div>
										원
									</div>
									<div class="funding-amount">
										<div>수익금 지급 예상일</div>
										<div id="exchangeDate">0</div>
									</div>
								</div>
							</div>
						</div>

						<div class="funding-info4">
							<div class="funding-info-title">포인트 충전</div>
							<div class="funding-info-container4">
								<div class="funding-pay-title">
									<div style="display: flex; justify-content: space-between">
										<input type="text" id="charge_money" class="form-control"
											placeholder="충전할 금액을 입력해주세요.">
										<button type="button" onclick="requestPay()"
											class="btn btn-primary">충전</button>
									</div>
								</div>
							</div>
							<div id="lackNowPoint"></div>
						</div>
						<!-- 포인트가 모자를 경우 모자른 금액 만큼 충전 후 결제될 수 있도록 여러 방안-->
						<div class="funding-info4">
							<div class="funding-info-title">최종 포인트 사용 정보</div>
							<div class="funding-info-container4">
								<div class="funding-pay-title">
									<div>CLOVER WALLET</div>
								</div>
								<div>
									<div class="funding-amount">
										<div>현재 포인트</div>
										<div id=""
											th:text="${#numbers.formatInteger(nowPoint,3,'COMMA')}">0</div>
										point
									</div>
									<div class="funding-amount">
										<div>사용 예정 포인트</div>
										<div id="expectPoint">0</div>
										point
									</div>
								</div>
								<div id="lackPoint">! 포인트잔액이 부족합니다. WALLET을 충전해주세요</div>


								<!-- 약관동의 -->
								<div class="funding-info5">
									<div class="form-check">
										<label class="form-check-label" for="flexCheckDefault">
											해당기업이 설정한 펀딩금액의 최소 금액만큼 투자금 미달성시 <br> 해당펀딩은 취소되며, 투자자가
											펀딩한 금액을 돌려받을 수있습니다.
										</label> <input class="form-check-input" type="checkbox" value=""
											id="flexCheckDefault">
									</div>
									<div class="form-check">
										<label class="form-check-label" for="flexCheckDefault">
											해당기업이 설정한 펀딩금액의 최소 금액만큼 투자금 미달성시<br> 해당펀딩은 취소되며, 투자자가
											펀딩한 금액을 돌려받을 수있습니다.
										</label> <input class="form-check-input" type="checkbox" value=""
											id="flexCheckDefault">
									</div>
									<div class="form-check">
										<label class="form-check-label" for="flexCheckDefault">
											펀딩정보 및 주의사항을 모두 확인했으며, 결제 진행에 동의합니다. </label> <input
											class="form-check-input" type="checkbox" value=""
											id="flexCheckDefault">
									</div>

								</div>
								<div>
									<button type="button" onclick="fundingPay()"
										class="btn btn-primary">펀딩하기</button>
								</div>

							</div>
						</div>
					</div>

				</div>
				<div class="footer">풋터</div>

			</div>
		</div>
	</div>
</body>
</html>
